<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Order Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --text-color: #333;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --app-font-size: 16px;
            --table-padding: 15px;
        }
        
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            font-size: var(--app-font-size);
        }

        /* Compact View */
        body.view-compact {
            --table-padding: 8px;
        }

        /* Layout & Navigation */
        .app-container {
            display: flex;
            width: 100%;
        }

        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            color: white;
            display: none; /* Hidden until logged in */
            flex-direction: column;
            padding: 20px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            transition: width 0.3s;
            z-index: 1000;
        }

        .sidebar h2 {
            text-align: center;
            margin: 0;
            font-size: 20px;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #34495e;
        }

        .toggle-btn {
            background: transparent !important;
            width: auto !important;
            padding: 0 5px;
            font-size: 24px;
            color: white;
            border: none;
            cursor: pointer;
        }

        .nav-item {
            padding: 15px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover, .nav-item.active {
            background-color: var(--primary-color);
        }

        /* Collapsed Sidebar Styles */
        .sidebar.collapsed {
            width: 70px;
        }
        .sidebar.collapsed .nav-text, 
        .sidebar.collapsed h2 { display: none; }
        .sidebar.collapsed .sidebar-header { justify-content: center; }

        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: 0; /* Adjusted via JS when sidebar is visible */
            min-width: 0;
            transition: margin-left 0.3s;
        }

        /* Views */
        .view-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .view-section.active {
            display: block;
        }

        .tracker-container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 800px;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        h2.section-title {
            color: var(--text-color);
            margin-bottom: 24px;
            font-size: 22px;
            font-weight: 700;
            display: block;
            letter-spacing: -0.5px;
        }

        /* Search Section */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 40px;
            justify-content: center;
        }

        input[type="text"] {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            width: 100%;
            font-size: var(--app-font-size);
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        select, input[type="number"], input[type="date"], input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: var(--app-font-size);
            box-sizing: border-box;
        }

        button {
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: var(--app-font-size);
            font-weight: 600;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        /* Minimalist Icon Buttons */
        .icon-btn {
            background-color: transparent;
            color: #7f8c8d;
            border: 1px solid #e0e0e0;
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover {
            background-color: #f8f9fa;
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-block {
            width: 100%;
        }

        /* Platform Logos & Tabs */
        .platform-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .platform-tab {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid #ddd;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .platform-tab:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .platform-tab.active {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .platform-tab img {
            width: auto;
            height: 35px;
            object-fit: contain;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.05);
            text-align: left;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        .stat-card h3 {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #95a5a6;
            margin: 0 0 12px 0;
            font-weight: 600;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
            line-height: 1.2;
        }

        .stat-sub-number {
            font-size: 14px;
            color: #bdc3c7;
            margin-top: 4px;
            font-weight: 500;
        }

        /* Dashboard Tabs */
        .dashboard-tabs {
            display: flex;
            gap: 15px;
            gap: 10px;
            margin-top: 30px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .dash-tab {
            background-color: var(--card-bg);
            border: 1px solid rgba(0,0,0,0.08);
            padding: 10px;
            padding: 5px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.2s;
            flex: 1;
            justify-content: center;
            min-width: 80px;
            width: 80px;
            height: 70px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .dash-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            color: var(--primary-color);
        }

        .dash-tab.active {
            background-color: white;
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.15);
        }

        .dash-tab img {
            width: auto;
            height: 50px;
            height: 100%;
            max-height: 50px;
            max-width: 100%;
            object-fit: contain;
        }

        .dash-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .dash-tab-content.active {
            display: block;
        }

        /* Treemap / Tiled Dashboard Styles */
        .treemap-section {
            margin-bottom: 20px;
        }

        .treemap-header {
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .treemap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .treemap-item {
            padding: 16px;
            border-radius: 12px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 110px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .treemap-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        /* Background Gradients */
        .bg-intransit { background: linear-gradient(135deg, #3498db, #2980b9); }
        .bg-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .bg-failed { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .bg-pending { background: linear-gradient(135deg, #f39c12, #d35400); }
        .bg-approved { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .bg-invalid { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
        .bg-notclaims { background: linear-gradient(135deg, #34495e, #2c3e50); }

        .tm-icon { font-size: 24px; margin-bottom: 8px; opacity: 0.9; }
        .tm-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; opacity: 0.9; margin-bottom: auto; }
        .tm-stats { margin-top: 10px; }
        .tm-count { font-size: 26px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
        .tm-amount { font-size: 13px; font-weight: 500; opacity: 0.95; }
        
        /* Decorative circle */
        .treemap-item::after {
            content: ''; position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-width: 100%;
            max-height: 75vh;
            overflow-y: auto;
            position: relative;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        /* Sticky Header */
        thead th {
            position: sticky;
            top: 0;
            z-index: 20;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Sticky Columns */
        th:nth-child(1), td:nth-child(1) { /* Checkbox */
            position: sticky;
            left: 0;
            z-index: 11;
            width: 40px;
            min-width: 40px;
        }
        th:nth-child(2), td:nth-child(2) { /* Month */
            position: sticky;
            left: 40px;
            z-index: 11;
            width: 50px;
            min-width: 50px;
        }
        th:nth-child(3), td:nth-child(3) { /* Order Date */
            position: sticky;
            left: 90px;
            z-index: 11;
            border-right: 2px solid #eee;
        }
        /* Header Intersection */
        thead th:nth-child(1), thead th:nth-child(2), thead th:nth-child(3) {
            z-index: 30;
        }

        th, td {
            padding: var(--table-padding);
            text-align: left;
            border: 1px solid #e0e0e0;
            white-space: nowrap;
            font-size: 11px;
            background-color: var(--card-bg);
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        tr:hover td {
            background-color: #f9f9f9;
        }
        tbody tr:nth-child(even) td {
            background-color: #f8f9fa;
        }
        tbody tr { cursor: pointer; }

        /* Order Details Section */
        #order-details {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .order-info h3 {
            margin: 0 0 5px 0;
        }

        .order-info p {
            margin: 0;
            color: #777;
        }

        /* Progress Steps */
        .progress-track {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 40px;
        }

        .progress-track::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #eee;
            z-index: 0;
        }

        .step {
            position: relative;
            z-index: 1;
            text-align: center;
            width: 25%;
        }

        .step-circle {
            width: 34px;
            height: 34px;
            background-color: #fff;
            border: 4px solid #eee;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #999;
            transition: all 0.4s;
        }

        .step-label {
            font-size: 14px;
            color: #999;
            font-weight: 500;
        }

        /* Active/Completed States */
        .step.active .step-circle {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }

        .step.completed .step-circle {
            border-color: var(--success-color);
            background-color: var(--success-color);
            color: white;
        }

        .step.active .step-label, 
        .step.completed .step-label {
            color: var(--text-color);
        }

        /* Progress Bar Fill */
        .progress-fill {
            position: absolute;
            top: 15px;
            left: 0;
            height: 4px;
            background-color: var(--success-color);
            z-index: 0;
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Error Message */
        .error-msg {
            color: #e74c3c;
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .status-1 { background-color: #95a5a6; } /* Placed */
        .status-2 { background-color: #f39c12; } /* Processing */
        .status-3 { background-color: #3498db; } /* Shipped */
        .status-4 { background-color: #2ecc71; } /* Delivered */

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes toast-in {
            from { opacity: 0; transform: translate(-50%, -50%) translateY(10px); }
            to { opacity: 1; transform: translate(-50%, -50%) translateY(0); }
        }

        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .sidebar {
                width: 60px;
                padding: 20px 5px;
            }
            .sidebar h2, .nav-text {
                display: none;
            }
            .main-content {
                margin-left: 60px !important; /* Override JS inline style if needed */
            }
            .search-box {
                flex-direction: column;
            }
            input[type="text"] {
                width: 100%;
                box-sizing: border-box;
            }
            button {
                width: 100%;
            }
            .step-label {
                font-size: 12px;
            }
        }

        /* --- Themes --- */
        
        /* Black Theme */
        body.theme-black {
            --primary-color: #3498db;
            --text-color: #e0e0e0;
            --bg-color: #000000;
            --card-bg: #121212;
            --sidebar-bg: #1a252f;
        }

        /* Navy Blue Theme */
        body.theme-navy {
            --primary-color: #64ffda;
            --text-color: #ccd6f6;
            --bg-color: #0a192f;
            --card-bg: #112240;
            --sidebar-bg: #020c1b;
        }

        /* Cream Theme */
        body.theme-cream {
            --primary-color: #d4a373;
            --text-color: #5d4037;
            --bg-color: #fefae0;
            --card-bg: #faedcd;
            --sidebar-bg: #d4a373;
        }

        /* Pastel Theme */
        body.theme-pastel {
            --primary-color: #ffb7b2;
            --text-color: #636e72;
            --bg-color: #fff0f5;
            --card-bg: #ffffff;
            --sidebar-bg: #c7ceea;
        }

        /* Shared Dark Theme Styles (Black & Navy) */
        body.theme-black .stat-card, 
        body.theme-black .table-container,
        body.theme-navy .stat-card, 
        body.theme-navy .table-container {
            background: var(--card-bg);
            color: var(--text-color);
        }

        body.theme-black .platform-tab.active,
        body.theme-navy .platform-tab.active {
            background-color: rgba(255,255,255,0.08);
            color: var(--text-color);
        }
        
        body.theme-black th,
        body.theme-navy th {
            background-color: var(--sidebar-bg);
            color: var(--text-color);
        }

        body.theme-black td, body.theme-black th, body.theme-black .order-header,
        body.theme-navy td, body.theme-navy th, body.theme-navy .order-header {
            border-color: rgba(255,255,255,0.1);
        }

        body.theme-black tr:hover td,
        body.theme-navy tr:hover td {
            background-color: rgba(255,255,255,0.05);
        }

        body.theme-black tbody tr:nth-child(even) td,
        body.theme-navy tbody tr:nth-child(even) td {
            background-color: rgba(255,255,255,0.02);
        }

        body.theme-black input, body.theme-black select,
        body.theme-navy input, body.theme-navy select {
            background-color: var(--card-bg);
            border-color: rgba(255,255,255,0.2);
            color: var(--text-color);
        }

        body.theme-black .progress-track::before,
        body.theme-navy .progress-track::before {
            background-color: rgba(255,255,255,0.2);
        }

        body.theme-black .step-circle,
        body.theme-navy .step-circle {
            background-color: var(--card-bg);
            border-color: rgba(255,255,255,0.2);
        }

        /* Settings Controls */
        .settings-btn-group button {
            margin-right: 10px;
            margin-bottom: 10px;
            width: auto;
        }

        /* Top Header & Profile Dropdown */
        .top-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            position: relative;
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-trigger {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .profile-trigger:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .profile-avatar {
            width: 32px;
            height: 32px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background-size: cover;
            background-position: center;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--card-bg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            width: 160px;
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 100;
            margin-top: 10px;
            border: 1px solid #eee;
        }

        .dropdown-menu.show {
            display: flex;
        }

        .dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-color);
        }

        .dropdown-item:hover {
            background-color: var(--bg-color);
        }

        #rememberMe {
            accent-color: var(--primary-color);
        }

        body.theme-black .profile-trigger:hover, body.theme-navy .profile-trigger:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        body.theme-black .dropdown-menu, body.theme-navy .dropdown-menu {
            border-color: rgba(255,255,255,0.1);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        .pagination button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Login Specific Styles */
        #login-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--sidebar-bg));
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        /* Ensure it hides when not active */
        #login-view:not(.active) {
            display: none !important;
        }
        
        #login-view.active {
            display: flex !important;
        }

        #login-view .tracker-container {
            max-width: 400px;
            margin: 0;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            animation: slideUp 0.5s ease;
        }

        .subtitle {
            text-align: center;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        /* Floating Labels */
        .form-group.floating {
    position: relative;
            margin-bottom: 25px;
        }
        .form-group.floating input {
            height: 50px;
        }
        .form-group.floating label {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            background-color: var(--card-bg);
            padding: 0 5px;
            color: #777;
            transition: 0.2s ease all;
            pointer-events: none;
            margin: 0;
            font-weight: normal;
        }
        .form-group.floating input:focus + label,
        .form-group.floating input:not(:placeholder-shown) + label {
            top: 0;
            font-size: 12px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        /* Floating Labels */
        .form-group.floating {
    position: relative;
            margin-bottom: 25px;
        }
        .form-group.floating input {
            height: 50px;
        }
        .form-group.floating label {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            background-color: var(--card-bg);
            padding: 0 5px;
            color: #777;
            transition: 0.2s ease all;
            pointer-events: none;
            margin: 0;
            font-weight: normal;
        }
        .form-group.floating input:focus + label,
        .form-group.floating input:not(:placeholder-shown) + label {
            top: 0;
            font-size: 12px;
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Editable Table Cells */
        td[contenteditable] {
            cursor: text;
            transition: background 0.2s;
        }
        td[contenteditable]:focus {
            background-color: rgba(52, 152, 219, 0.1);
            outline: none;
            box-shadow: inset 0 0 0 2px var(--primary-color);
        }
        td[contenteditable]:empty::before {
            content: attr(data-placeholder);
            color: #ccc;
        }

        /* Drag & Drop */
        .draggable { cursor: grab; }
        .draggable:active { cursor: grabbing; }
        .drag-over { border: 2px dashed var(--primary-color); }

        /* Inline Edit Inputs */
        .edit-input {
            width: 100%;
            padding: 4px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 12px;
        }

        /* Table View Toggle (Fullscreen) */
        body.table-only-mode .sidebar,
        body.table-only-mode .top-header,
        body.table-only-mode .section-title,
        body.table-only-mode .search-box {
            display: none !important;
        }

        body.table-only-mode .main-content {
            margin-left: 0 !important;
            padding: 0 !important;
            width: 100%;
            height: 100vh;
        }

        body.table-only-mode #list-view {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        body.table-only-mode .table-container {
            flex: 1;
            max-height: none;
            border-radius: 0;
            box-shadow: none;
        }

        body.table-only-mode .pagination {
            background: var(--card-bg);
            padding: 10px;
            border-top: 1px solid #eee;
            margin: 0;
            flex-shrink: 0;
        }

        #exitTableViewBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            background-color: #e74c3c;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-radius: 50px;
            padding: 12px 24px;
        }

        body.table-only-mode #exitTableViewBtn {
            display: block;
        }

        #darkModeToggleBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 180px;
            z-index: 2000;
            background-color: #2c3e50;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-radius: 50px;
            padding: 12px 24px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        body.table-only-mode #darkModeToggleBtn {
            display: block;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            backdrop-filter: blur(2px);
        }
        
        #loading-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>OrderSys</h2>
            <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
        </div>
        <div class="nav-item active" onclick="showView('dashboard')">
            <span>üìä</span> <span class="nav-text">Dashboard</span>
        </div>
        <div class="nav-item" onclick="showView('list')">
            <span>üìã</span> <span class="nav-text">Order List</span>
        </div>
        <div class="nav-item" onclick="showView('report')">
            <span>üìà</span> <span class="nav-text">Reports</span>
        </div>
        <div class="nav-item" style="margin-top: auto;" onclick="logout()">
            <span>üö™</span> <span class="nav-text">Logout</span> 
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content" id="mainContent">
        
        <!-- Top Header (Profile) -->
        <header id="topHeader" class="top-header" style="display: none;">
            <div class="profile-dropdown">
                <div class="profile-trigger" onclick="toggleProfileMenu(event)">
                    <div class="profile-avatar" id="headerAvatar">A</div>
                    <span class="profile-name" id="headerName">Admin</span>
                    <span>‚ñº</span>
                </div>
                <div class="dropdown-menu" id="profileMenu">
                    <div class="dropdown-item" onclick="showView('profile')">Profile</div>
                    <div class="dropdown-item" onclick="showView('settings')">Settings</div>
                    <div class="dropdown-item" onclick="logout()">Logout</div>
                </div>
            </div>
        </header>
        
        <!-- 1. Login View -->
        <section id="login-view" class="view-section active">
            <div class="tracker-container">
                <p class="subtitle">Enter your credentials to access the dashboard.</p>
                <div class="form-group floating">
                    <input type="text" id="username" placeholder=" ">
                    <label>Username</label>
                </div>
                <div class="form-group floating">
                    <input type="password" id="password" placeholder=" ">
                    <label>Password</label>
                </div>
                <div class="form-group" style="display: flex; align-items: center;">
                    <input type="checkbox" id="rememberMe" style="width: auto; margin-right: 10px;">
                    <label for="rememberMe" style="margin-bottom: 0; font-weight: normal;">Remember Me</label>
                </div>
                <button class="btn-block" id="loginBtn" onclick="login()">Login</button>
                <p id="loginError" class="error-msg">Invalid credentials</p>
            </div>
        </section>

        <!-- 2. Dashboard View -->
        <section id="dashboard-view" class="view-section">
            <h2 class="section-title">Dashboard Overview</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;">
                <div style="flex: 1; min-width: 200px; display: flex; flex-direction: column; gap: 20px;">
                    <div class="stat-card" style="flex: 1; justify-content: center;">
                        <h3>Total Orders</h3>
                        <div class="stat-number" id="dash-total">0</div>
                    </div>
                    <div class="stat-card" style="flex: 1; justify-content: center;">
                        <h3>Total Amount</h3>
                        <div class="stat-number" id="dash-revenue">‚Ç±0</div>
                    </div>
                </div>
                
                <div class="tracker-container" style="flex: 3; min-width: 300px; margin: 0; max-width: none;">
                    <h3>Delivery Status Distribution</h3>
                    <div style="height: 300px;">
                        <canvas id="overviewChart"></canvas>
                    </div>
                </div>
            </div>

            <h2 class="section-title" style="margin-top: 30px;">Order Status in WINS by Platform</h2>
            
            <!-- Dashboard Tabs Navigation -->
            <div class="dashboard-tabs">
                <button class="dash-tab" onclick="openDashTab('all')" style="width: auto; padding: 0 20px;">
                    All Platform
                </button>
                <button class="dash-tab active" onclick="openDashTab('tiktok')">
                    <img src="https://upload.wikimedia.org/wikipedia/en/a/a9/TikTok_logo.svg" alt="TikTok">
                </button>
                <button class="dash-tab" onclick="openDashTab('shopee')">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fe/Shopee.svg" alt="Shopee">
                </button>
                <button class="dash-tab" onclick="openDashTab('lazada')">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/4/4d/Lazada_%282019%29.svg" alt="Lazada">
                </button>
                <button class="dash-tab" onclick="openDashTab('watsons')">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/d/dd/Watsons_logotype.svg" alt="Watsons">
                </button>
            </div>

            <!-- All Platforms -->
            <div id="dash-tab-all" class="dash-tab-content">
                <div class="treemap-section">
                    <div class="treemap-header">Delivery Status (All)</div>
                    <div class="treemap-grid">
                        <div class="treemap-item bg-intransit">
                            <div class="tm-icon">üöö</div>
                            <div class="tm-label">Intransit</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-all-wins-intransit">0</div>
                                <div class="tm-amount" id="dash-all-wins-intransit-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-success">
                            <div class="tm-icon">‚úÖ</div>
                            <div class="tm-label">Success</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-all-wins-success">0</div>
                                <div class="tm-amount" id="dash-all-wins-success-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-failed">
                            <div class="tm-icon">‚ùå</div>
                            <div class="tm-label">Failed</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-all-wins-failed">0</div>
                                <div class="tm-amount" id="dash-all-wins-failed-total">‚Ç±0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="treemap-section">
                    <div class="treemap-header">Claims Status (All)</div>
                    <div class="treemap-grid">
                        <div class="treemap-item bg-pending">
                            <div class="tm-icon">‚è≥</div>
                            <div class="tm-label">Pending</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-all-claims-pending-count">0</div>
                                <div class="tm-amount" id="dash-all-claims-pending-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-approved">
                            <div class="tm-icon">üëç</div>
                            <div class="tm-label">Approved</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-all-claims-approved-count">0</div>
                                <div class="tm-amount" id="dash-all-claims-approved-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-invalid">
                            <div class="tm-icon">üö´</div>
                            <div class="tm-label">Invalid</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-all-claims-invalid-count">0</div>
                                <div class="tm-amount" id="dash-all-claims-invalid-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-notclaims">
                            <div class="tm-icon">üõë</div>
                            <div class="tm-label">Not for Claims</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-all-claims-notforclaims-count">0</div>
                                <div class="tm-amount" id="dash-all-claims-notforclaims-total">‚Ç±0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TikTok -->
            <div id="dash-tab-tiktok" class="dash-tab-content active">
                <div class="treemap-section">
                    <div class="treemap-header">Delivery Status</div>
                    <div class="treemap-grid">
                        <div class="treemap-item bg-intransit">
                            <div class="tm-icon">üöö</div>
                            <div class="tm-label">Intransit</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-tiktok-wins-intransit">0</div>
                                <div class="tm-amount" id="dash-tiktok-wins-intransit-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-success">
                            <div class="tm-icon">‚úÖ</div>
                            <div class="tm-label">Success</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-tiktok-wins-success">0</div>
                                <div class="tm-amount" id="dash-tiktok-wins-success-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-failed">
                            <div class="tm-icon">‚ùå</div>
                            <div class="tm-label">Failed</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-tiktok-wins-failed">0</div>
                                <div class="tm-amount" id="dash-tiktok-wins-failed-total">‚Ç±0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="treemap-section">
                    <div class="treemap-header">Claims Status</div>
                    <div class="treemap-grid">
                        <div class="treemap-item bg-pending">
                            <div class="tm-icon">‚è≥</div>
                            <div class="tm-label">Pending</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-tiktok-claims-pending-count">0</div>
                                <div class="tm-amount" id="dash-tiktok-claims-pending-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-approved">
                            <div class="tm-icon">üëç</div>
                            <div class="tm-label">Approved</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-tiktok-claims-approved-count">0</div>
                                <div class="tm-amount" id="dash-tiktok-claims-approved-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-invalid">
                            <div class="tm-icon">üö´</div>
                            <div class="tm-label">Invalid</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-tiktok-claims-invalid-count">0</div>
                                <div class="tm-amount" id="dash-tiktok-claims-invalid-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-notclaims">
                            <div class="tm-icon">üõë</div>
                            <div class="tm-label">Not for Claims</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-tiktok-claims-notforclaims-count">0</div>
                                <div class="tm-amount" id="dash-tiktok-claims-notforclaims-total">‚Ç±0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shopee -->
            <div id="dash-tab-shopee" class="dash-tab-content">
                <div class="treemap-section">
                    <div class="treemap-header">Delivery Status</div>
                    <div class="treemap-grid">
                        <div class="treemap-item bg-intransit">
                            <div class="tm-icon">üöö</div>
                            <div class="tm-label">Intransit</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-shopee-wins-intransit">0</div>
                                <div class="tm-amount" id="dash-shopee-wins-intransit-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-success">
                            <div class="tm-icon">‚úÖ</div>
                            <div class="tm-label">Success</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-shopee-wins-success">0</div>
                                <div class="tm-amount" id="dash-shopee-wins-success-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-failed">
                            <div class="tm-icon">‚ùå</div>
                            <div class="tm-label">Failed</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-shopee-wins-failed">0</div>
                                <div class="tm-amount" id="dash-shopee-wins-failed-total">‚Ç±0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="treemap-section">
                    <div class="treemap-header">Claims Status</div>
                    <div class="treemap-grid">
                        <div class="treemap-item bg-pending">
                            <div class="tm-icon">‚è≥</div>
                            <div class="tm-label">Pending</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-shopee-claims-pending-count">0</div>
                                <div class="tm-amount" id="dash-shopee-claims-pending-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-approved">
                            <div class="tm-icon">üëç</div>
                            <div class="tm-label">Approved</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-shopee-claims-approved-count">0</div>
                                <div class="tm-amount" id="dash-shopee-claims-approved-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-invalid">
                            <div class="tm-icon">üö´</div>
                            <div class="tm-label">Invalid</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-shopee-claims-invalid-count">0</div>
                                <div class="tm-amount" id="dash-shopee-claims-invalid-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-notclaims">
                            <div class="tm-icon">üõë</div>
                            <div class="tm-label">Not for Claims</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-shopee-claims-notforclaims-count">0</div>
                                <div class="tm-amount" id="dash-shopee-claims-notforclaims-total">‚Ç±0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lazada -->
            <div id="dash-tab-lazada" class="dash-tab-content">
                <div class="treemap-section">
                    <div class="treemap-header">Delivery Status</div>
                    <div class="treemap-grid">
                        <div class="treemap-item bg-intransit">
                            <div class="tm-icon">üöö</div>
                            <div class="tm-label">Intransit</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-lazada-wins-intransit">0</div>
                                <div class="tm-amount" id="dash-lazada-wins-intransit-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-success">
                            <div class="tm-icon">‚úÖ</div>
                            <div class="tm-label">Success</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-lazada-wins-success">0</div>
                                <div class="tm-amount" id="dash-lazada-wins-success-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-failed">
                            <div class="tm-icon">‚ùå</div>
                            <div class="tm-label">Failed</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-lazada-wins-failed">0</div>
                                <div class="tm-amount" id="dash-lazada-wins-failed-total">‚Ç±0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="treemap-section">
                    <div class="treemap-header">Claims Status</div>
                    <div class="treemap-grid">
                        <div class="treemap-item bg-pending">
                            <div class="tm-icon">‚è≥</div>
                            <div class="tm-label">Pending</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-lazada-claims-pending-count">0</div>
                                <div class="tm-amount" id="dash-lazada-claims-pending-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-approved">
                            <div class="tm-icon">üëç</div>
                            <div class="tm-label">Approved</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-lazada-claims-approved-count">0</div>
                                <div class="tm-amount" id="dash-lazada-claims-approved-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-invalid">
                            <div class="tm-icon">üö´</div>
                            <div class="tm-label">Invalid</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-lazada-claims-invalid-count">0</div>
                                <div class="tm-amount" id="dash-lazada-claims-invalid-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-notclaims">
                            <div class="tm-icon">üõë</div>
                            <div class="tm-label">Not for Claims</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-lazada-claims-notforclaims-count">0</div>
                                <div class="tm-amount" id="dash-lazada-claims-notforclaims-total">‚Ç±0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Watsons -->
            <div id="dash-tab-watsons" class="dash-tab-content">
                <div class="treemap-section">
                    <div class="treemap-header">Delivery Status</div>
                    <div class="treemap-grid">
                        <div class="treemap-item bg-intransit">
                            <div class="tm-icon">üöö</div>
                            <div class="tm-label">Intransit</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-watsons-wins-intransit">0</div>
                                <div class="tm-amount" id="dash-watsons-wins-intransit-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-success">
                            <div class="tm-icon">‚úÖ</div>
                            <div class="tm-label">Success</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-watsons-wins-success">0</div>
                                <div class="tm-amount" id="dash-watsons-wins-success-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-failed">
                            <div class="tm-icon">‚ùå</div>
                            <div class="tm-label">Failed</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-watsons-wins-failed">0</div>
                                <div class="tm-amount" id="dash-watsons-wins-failed-total">‚Ç±0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="treemap-section">
                    <div class="treemap-header">Claims Status</div>
                    <div class="treemap-grid">
                        <div class="treemap-item bg-pending">
                            <div class="tm-icon">‚è≥</div>
                            <div class="tm-label">Pending</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-watsons-claims-pending-count">0</div>
                                <div class="tm-amount" id="dash-watsons-claims-pending-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-approved">
                            <div class="tm-icon">üëç</div>
                            <div class="tm-label">Approved</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-watsons-claims-approved-count">0</div>
                                <div class="tm-amount" id="dash-watsons-claims-approved-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-invalid">
                            <div class="tm-icon">üö´</div>
                            <div class="tm-label">Invalid</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-watsons-claims-invalid-count">0</div>
                                <div class="tm-amount" id="dash-watsons-claims-invalid-total">‚Ç±0.00</div>
                            </div>
                        </div>
                        <div class="treemap-item bg-notclaims">
                            <div class="tm-icon">üõë</div>
                            <div class="tm-label">Not for Claims</div>
                            <div class="tm-stats">
                                <div class="tm-count" id="dash-watsons-claims-notforclaims-count">0</div>
                                <div class="tm-amount" id="dash-watsons-claims-notforclaims-total">‚Ç±0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. Order List View -->
        <section id="list-view" class="view-section">
            <button id="exitTableViewBtn" onclick="toggleTableView()">Exit Fullscreen</button>
            <button id="darkModeToggleBtn" onclick="toggleDarkMode()">üåô Dark Mode</button>
            
            <div class="platform-tabs">
                <button class="platform-tab active" onclick="switchPlatform('Tiktok')" data-platform="Tiktok">
                    <img src="https://upload.wikimedia.org/wikipedia/en/a/a9/TikTok_logo.svg" alt="TikTok Shop">
                </button>
                <button class="platform-tab" onclick="switchPlatform('Shopee')" data-platform="Shopee">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fe/Shopee.svg" alt="Shopee">
                </button>
                <button class="platform-tab" onclick="switchPlatform('Lazada')" data-platform="Lazada">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/4/4d/Lazada_%282019%29.svg" alt="Lazada">
                </button>
                <button class="platform-tab" onclick="switchPlatform('Watsons')" data-platform="Watsons">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/d/dd/Watsons_logotype.svg" alt="Watsons">
                </button>
            </div>

            <div class="search-box" style="display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 15px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap; flex: 1;">
                    <input type="text" id="filterId" placeholder="Order ID" onkeyup="filterOrders()" style="flex: 1; min-width: 120px;">
                    <input type="text" id="filterStatus" placeholder="Status" onkeyup="filterOrders()" style="flex: 1; min-width: 120px;">
                    <input type="date" id="filterStartDate" onchange="filterOrders()" style="flex: 1; min-width: 130px;" title="Start Date">
                    <input type="date" id="filterEndDate" onchange="filterOrders()" style="flex: 1; min-width: 130px;" title="End Date">
                    <button onclick="resetFilters()" title="Reset Filters" class="icon-btn">üîÑ</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="toggleTableView()" title="Table View" class="icon-btn">‚õ∂</button>
                    <button onclick="downloadSampleCSV()" title="Download Sample CSV" class="icon-btn">üìÑ</button>
                    <button onclick="document.getElementById('csvUpload').click()" title="Import CSV" class="icon-btn">üìÇ</button>
                    <button onclick="exportToCSV()" title="Export CSV" class="icon-btn">üíæ</button>
                    <button onclick="deleteSelectedOrders()" title="Delete Selected" class="icon-btn">üóëÔ∏è</button>
                    <button onclick="clearAllData()" title="Clear All Data" class="icon-btn">‚ùå</button>
                    <input type="file" id="csvUpload" accept=".csv" style="display: none;" onchange="handleFileUpload(this)">
                </div>
            </div>
            <div class="table-container">
                <table id="ordersTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllOrders" onclick="toggleAllCheckboxes(this)"></th>
                            <th>Month</th>
                            <th>Order Date</th>
                            <th>Ship Date Time</th>
                            <th>Delivery Date</th>
                            <th>Ageing Days</th>
                            <th>Order Number</th>
                            <th id="platformIdHeader">Tiktok Order ID</th>
                            <th>Units Shipped</th>
                            <th>MOP</th>
                            <th>SC Order Status</th>
                            <th>SC Order Sub Status</th>
                            <th>OMM Customer Order Status</th>
                            <th>OMM Consignment Status</th>
                            <th>WINS Status</th>
                            <th>Sales/TLOG</th>
                            <th>RTS PO NO</th>
                            <th>RTS PO Status</th>
                            <th>Return Status</th>
                            <th>Return Reason</th>
                            <th>Cancel Reason</th>
                            <th>Physical Stocks</th>
                            <th>RTV Date Endorse to IC</th>
                            <th>Ticket Number</th>
                            <th>Date Filed</th>
                            <th>Feedback Date</th>
                            <th>DF Claims Status</th>
                            <th>Del-Failed Reason</th>
                            <th>Return/Refund</th>
                            <th>RR Claims Status</th>
                            <th>Claims Reason</th>
                            <th>Tracking No.</th>
                            <th>Logistics Del</th>
                            <th>Region</th>
                            <th>Province</th>
                            <th>Order Status Final Remarks</th>
                            <th>Total Cost</th>
                            <th>Total Retail</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
            <div class="pagination" style="position: relative;">
                <select id="rowsPerPage" onchange="changeItemsPerPage()" style="width: auto; padding: 8px; position: absolute; left: 0;">
                    <option value="5">5 rows</option>
                    <option value="10">10 rows</option>
                    <option value="25">25 rows</option>
                    <option value="50">50 rows</option>
                    <option value="100">100 rows</option>
                </select>
                <button id="prevBtn" onclick="changePage(-1)" style="padding: 6px 10px;">Previous</button>
                <span id="pageInfo">Page 1 of 1</span>
                <button id="nextBtn" onclick="changePage(1)" style="padding: 6px 10px;">Next</button>
            </div>
        </section>

        <!-- 5. Report View -->
        <section id="report-view" class="view-section">
            <h2 class="section-title">Reports</h2>
            <div class="tracker-container" style="margin-bottom: 20px;">
                <h3>Order Status Breakdown</h3>
                <div id="report-content">
                    <!-- Simple text report -->
                </div>
            </div>
            
            <div class="tracker-container">
                <h3>Custom Chart Generator</h3>
                <div class="form-group">
                    <label>Chart Type</label>
                    <select id="chartTypeSelector" onchange="saveManualData()">
                        <option value="bar">Bar Chart</option>
                        <option value="pie">Pie Chart</option>
                        <option value="doughnut">Doughnut Chart</option>
                        <option value="line">Line Chart</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <input type="checkbox" id="useSecondaryAxis" style="width: auto;" onchange="saveManualData(); renderManualChart()">
                    <label for="useSecondaryAxis" style="margin: 0; font-weight: normal;">Render last column as Secondary Line (Dual Axis)</label>
                </div>
                <div style="text-align: right; margin-bottom: 5px;">
                    <button onclick="transposeTable()" title="Swap rows and columns" style="padding: 5px 10px; font-size: 12px; width: auto; background-color: #7f8c8d; margin-right: 5px;">Transpose ‚áÖ</button>
                    <button onclick="addColumn()" style="padding: 5px 10px; font-size: 12px; width: auto; background-color: #34495e;">+ Add Column</button>
                </div>
                <table id="manualReportTable" style="margin-bottom: 15px;">
                    <thead>
                        <tr id="manualHeaderRow">
                            <th>Label</th>
                            <th style="width: 60px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="manualReportBody"></tbody>
                </table>
                <button onclick="addManualRow()" style="margin-bottom: 15px; background-color: #95a5a6; width: auto;">+ Add Row</button>
                <div id="manualTotalsContainer" style="text-align: right; font-size: 1.2em; margin-bottom: 20px;">
                    <!-- Dynamic totals -->
                </div>
                <button class="btn-block" onclick="renderManualChart()">Generate Chart</button>
                <div style="margin-top: 30px;">
                    <canvas id="customChartCanvas"></canvas>
                </div>
            </div>
        </section>

        <!-- 7. Settings View -->
        <section id="settings-view" class="view-section">
            <h2 class="section-title">Settings</h2>
            <div class="tracker-container">
                <h3>Appearance</h3>
                <div class="form-group">
                    <label>Font Size</label>
                    <div class="settings-btn-group">
                        <button onclick="setFontSize('small')">Small</button>
                        <button onclick="setFontSize('medium')">Medium</button>
                        <button onclick="setFontSize('large')">Large</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>View Density</label>
                    <div class="settings-btn-group">
                        <button onclick="setDensity('comfortable')">Comfortable</button>
                        <button onclick="setDensity('compact')">Compact</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Theme Color</label>
                    <div class="settings-btn-group">
                        <button onclick="applyTheme('light')">Light</button>
                        <button onclick="applyTheme('black')">Black</button>
                        <button onclick="applyTheme('navy')">Navy</button>
                        <button onclick="applyTheme('cream')">Cream</button>
                        <button onclick="applyTheme('pastel')">Pastel</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 8. Profile View -->
        <section id="profile-view" class="view-section">
            <h2 class="section-title">My Profile</h2>
            <div class="tracker-container">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div id="profilePreview" class="profile-avatar" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto; background-color: var(--primary-color);">A</div>
                </div>
                <div class="form-group">
                    <label>Profile Image</label>
                    <input type="file" id="avatarUpload" accept="image/*" onchange="handleImageUpload(this)">
                    <button onclick="removeAvatarImage()" style="margin-top: 5px; background-color: #e74c3c; padding: 8px; width: auto; font-size: 12px;">Remove Image</button>
                </div>
                <div class="form-group">
                    <label>Avatar Color</label>
                    <input type="color" id="editColor" style="height: 50px; padding: 5px; cursor: pointer;" onchange="updatePreview()">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="editUsername">
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="editPassword" placeholder="Leave blank to keep current">
                </div>
                <button class="btn-block" onclick="saveProfile()">Save Changes</button>
            </div>
        </section>

    </main>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="spinner" style="width: 40px; height: 40px; border-width: 4px; margin-bottom: 15px;"></div>
    <h3>Processing Data...</h3>
</div>

<script>
    // Mock Database
    let orders = JSON.parse(localStorage.getItem('ordersData')) || {
        '1001': { id: '1001', platform: 'Tiktok', customer: 'Alice Smith', status: 'Delivered', date: '2023-10-28', total: 120.50, items: 3 },
        '1002': { id: '1002', platform: 'Tiktok', customer: 'Bob Jones', status: 'Shipped', date: '2023-11-02', total: 45.00, items: 1 },
        '1003': { id: '1003', platform: 'Tiktok', customer: 'Charlie Day', status: 'Processing', date: '2023-11-05', total: 210.99, items: 5 },
        '1004': { id: '1004', platform: 'Tiktok', customer: 'Dana White', status: 'Placed', date: '2023-11-10', total: 15.00, items: 1 },
        '2001': { id: '2001', platform: 'Shopee', customer: 'Eve Polastri', status: 'Placed', date: '2023-11-12', total: 35.00, items: 2 },
        '3001': { id: '3001', platform: 'Lazada', customer: 'Frank Castle', status: 'Shipped', date: '2023-11-14', total: 80.00, items: 1 },
        '4001': { id: '4001', platform: 'Watsons', customer: 'Grace Shelby', status: 'Delivered', date: '2023-11-16', total: 25.50, items: 4 }
    };
    let currentPage = 1;
    let itemsPerPage = 5;
    let currentSort = { column: null, direction: 'asc' };
    let overviewChartInstance = null;
    
    // Column Mapping for Editing and Rendering
    const columnKeys = [
        null, // 1: Month (Derived)
        'date', // 2
        'shipDateTime', // 3
        'deliveryDate', // 4
        null, // 5: Ageing (Derived)
        'id', // 6
        'tiktokId', // 7
        'items', // 8
        'mop', // 9
        'status', // 10
        'scSubStatus', // 11
        'ommStatus', // 12
        'ommConsignment', // 13
        'winsStatus', // 14
        'salesTlog', // 15
        'rtsPoNo', // 16
        'rtsPoStatus', // 17
        'returnStatus', // 18
        'returnReason', // 19
        'cancelReason', // 20
        'physicalStocks', // 21
        'rtvDate', // 22
        'ticketNumber', // 23
        'dateFiled', // 24
        'feedbackDate', // 25
        'dfClaimsStatus', // 26
        'delFailedReason', // 27
        'returnRefund', // 28
        'rrClaimsStatus', // 29
        'claimsReason', // 30
        'trackingNo', // 31
        'logisticsDel', // 32
        'region', // 33
        'province', // 34
        'remarks', // 35
        'cost', // 36
        'total' // 37
    ];

    // User Data Management
    const defaultUser = { username: 'admin', password: 'admin', color: '#3498db' };
    
    function getUserData() {
        return JSON.parse(localStorage.getItem('userProfile')) || defaultUser;
    }

    function saveOrdersToStorage() {
        localStorage.setItem('ordersData', JSON.stringify(orders));
    }

    // --- Navigation & Auth ---

    function login() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        const btn = document.getElementById('loginBtn');
        const errorMsg = document.getElementById('loginError');
        const storedUser = getUserData();
        const remember = document.getElementById('rememberMe').checked;
        
        // UI Loading State
        errorMsg.style.display = 'none';
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Logging in...';

        setTimeout(() => {
            if (user === storedUser.username && pass === storedUser.password) {
                if (remember) {
                    localStorage.setItem('isLoggedIn', 'true');
                } else {
                    sessionStorage.setItem('isLoggedIn', 'true');
                }
                document.getElementById('sidebar').style.display = 'flex';
                document.getElementById('mainContent').style.marginLeft = '250px';
                document.getElementById('topHeader').style.display = 'flex';
                updateHeaderProfile();
                showView('dashboard');
            } else {
                errorMsg.style.display = 'block';
            }
            // Reset button
            btn.disabled = false;
            btn.innerText = 'Login';
        }, 1000);
    }

    function logout() {
        localStorage.removeItem('isLoggedIn');
        sessionStorage.removeItem('isLoggedIn');
        localStorage.removeItem('currentView');
        document.getElementById('sidebar').style.display = 'none';
        document.getElementById('mainContent').style.marginLeft = '0';
        document.getElementById('topHeader').style.display = 'none';
        showView('login');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    }

    function updateHeaderProfile() {
        const user = getUserData();
        const avatar = document.getElementById('headerAvatar');
        const name = document.getElementById('headerName');

        name.innerText = user.username;
        
        if (user.avatarImage) {
            avatar.style.backgroundImage = `url(${user.avatarImage})`;
            avatar.innerText = '';
            avatar.style.backgroundColor = 'transparent';
        } else {
            avatar.style.backgroundImage = 'none';
            avatar.innerText = user.username.charAt(0).toUpperCase();
            avatar.style.backgroundColor = user.color;
        }
    }

    function updatePreview() {
        const color = document.getElementById('editColor').value;
        const preview = document.getElementById('profilePreview');
        preview.style.backgroundColor = color;
        
        // Only show text if no image is set
        const hasImage = preview.style.backgroundImage && preview.style.backgroundImage !== 'none';
        
        if (!hasImage) {
             const username = document.getElementById('editUsername').value || 'A';
             preview.innerText = username.charAt(0).toUpperCase();
        } else {
             preview.innerText = '';
        }
    }

    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('profilePreview');
                preview.style.backgroundImage = `url(${e.target.result})`;
                preview.innerText = '';
                preview.dataset.tempImage = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function removeAvatarImage() {
        const preview = document.getElementById('profilePreview');
        document.getElementById('avatarUpload').value = '';
        preview.style.backgroundImage = 'none';
        preview.dataset.tempImage = ''; // Mark as removed
        updatePreview(); // Restore text/color
    }

    function saveProfile() {
        const username = document.getElementById('editUsername').value;
        const password = document.getElementById('editPassword').value;
        const color = document.getElementById('editColor').value;
        const preview = document.getElementById('profilePreview');
        
        if(!username) return alert("Username cannot be empty");
        
        const currentUser = getUserData();
        
        // Determine image: if dataset.tempImage is set (string or empty), use it. 
        // If undefined (user didn't touch), keep current.
        let finalImage = currentUser.avatarImage;
        if (preview.dataset.tempImage !== undefined) {
            finalImage = preview.dataset.tempImage;
        }

        const newUser = {
            username: username,
            password: password ? password : currentUser.password,
            color: color,
            avatarImage: finalImage
        };
        
        localStorage.setItem('userProfile', JSON.stringify(newUser));
        updateHeaderProfile();
        
        // Update preview text just in case image was removed
        if (!finalImage) {
            preview.innerText = username.charAt(0).toUpperCase();
        }
        
        alert("Profile updated successfully!");
    }

    function showView(viewName) {
        // Hide all views
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        // Show selected
        document.getElementById(viewName + '-view').classList.add('active');
        
        // Update Sidebar Active State
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // Find the nav item that calls this view (simple matching)
        const navItems = document.querySelectorAll('.nav-item');
        if(viewName === 'dashboard') navItems[0].classList.add('active');
        if(viewName === 'list') navItems[1].classList.add('active');
        if(viewName === 'report') navItems[2].classList.add('active');
        
        // Populate Profile View if selected
        if (viewName === 'profile') {
            const user = getUserData();
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editColor').value = user.color;
            
            const preview = document.getElementById('profilePreview');
            preview.style.backgroundColor = user.color;
            
            // Reset temp state
            delete preview.dataset.tempImage;

            if (user.avatarImage) {
                preview.style.backgroundImage = `url(${user.avatarImage})`;
                preview.innerText = '';
            } else {
                preview.style.backgroundImage = 'none';
                preview.innerText = user.username.charAt(0).toUpperCase();
            }
        }

        // Refresh data if needed
        if (viewName === 'dashboard') updateDashboard();
        if (viewName === 'list') {
            resetFilters();
            // Ensure correct tab is active
            switchPlatform(currentPlatform);
        }
        if (viewName === 'report') {
            generateReport();
            if(document.getElementById('manualReportBody').children.length === 0) loadManualData();
        }

        // Persist View
        if (viewName !== 'login') {
            localStorage.setItem('currentView', viewName);
        }
    }

    // --- Dashboard Logic ---
    function updateDashboard() {
        const allOrders = Object.values(orders);

        // --- Update GLOBAL top cards ---
        document.getElementById('dash-total').innerText = allOrders.length;
        const totalRevenue = allOrders.reduce((acc, curr) => acc + (curr.total || 0), 0);
        document.getElementById('dash-revenue').innerText = '‚Ç±' + totalRevenue.toFixed(2);

        // --- Initialize stats object for all platforms ---
        const platformStats = {
            All: { successCount: 0, successTotal: 0, failedCount: 0, failedTotal: 0, intransitCount: 0, intransitTotal: 0, pendingClaimsCount: 0, pendingClaimsTotal: 0, approvedClaimsCount: 0, approvedClaimsTotal: 0, invalidClaimsCount: 0, invalidClaimsTotal: 0, notForClaimsCount: 0, notForClaimsTotal: 0 },
            Tiktok: { successCount: 0, successTotal: 0, failedCount: 0, failedTotal: 0, intransitCount: 0, intransitTotal: 0, pendingClaimsCount: 0, pendingClaimsTotal: 0, approvedClaimsCount: 0, approvedClaimsTotal: 0, invalidClaimsCount: 0, invalidClaimsTotal: 0, notForClaimsCount: 0, notForClaimsTotal: 0 },
            Shopee: { successCount: 0, successTotal: 0, failedCount: 0, failedTotal: 0, intransitCount: 0, intransitTotal: 0, pendingClaimsCount: 0, pendingClaimsTotal: 0, approvedClaimsCount: 0, approvedClaimsTotal: 0, invalidClaimsCount: 0, invalidClaimsTotal: 0, notForClaimsCount: 0, notForClaimsTotal: 0 },
            Lazada: { successCount: 0, successTotal: 0, failedCount: 0, failedTotal: 0, intransitCount: 0, intransitTotal: 0, pendingClaimsCount: 0, pendingClaimsTotal: 0, approvedClaimsCount: 0, approvedClaimsTotal: 0, invalidClaimsCount: 0, invalidClaimsTotal: 0, notForClaimsCount: 0, notForClaimsTotal: 0 },
            Watsons: { successCount: 0, successTotal: 0, failedCount: 0, failedTotal: 0, intransitCount: 0, intransitTotal: 0, pendingClaimsCount: 0, pendingClaimsTotal: 0, approvedClaimsCount: 0, approvedClaimsTotal: 0, invalidClaimsCount: 0, invalidClaimsTotal: 0, notForClaimsCount: 0, notForClaimsTotal: 0 }
        };

        // --- Calculate WINS status breakdown for each platform ---
        allOrders.forEach(o => {
            const platform = o.platform;
            
            const updateStats = (stats, order) => {
                // WINS Status
                const winsStatus = String(order.winsStatus || '').toLowerCase().trim();
                if (winsStatus === 'delivery success') {
                    stats.successCount++;
                    stats.successTotal += (order.total || 0);
                } else if (winsStatus === 'delivery failed') {
                    stats.failedCount++;
                    stats.failedTotal += (order.total || 0);
                } else if (winsStatus === 'intransit') {
                    stats.intransitCount++;
                    stats.intransitTotal += (order.total || 0);
                }

                // Claims Status
                const claimsStatus = String(order.rrClaimsStatus || '').toLowerCase().trim();
                if (claimsStatus === 'pending') {
                    stats.pendingClaimsCount++;
                    stats.pendingClaimsTotal += (order.total || 0);
                } else if (claimsStatus === 'approved') {
                    stats.approvedClaimsCount++;
                    stats.approvedClaimsTotal += (order.total || 0);
                } else if (claimsStatus === 'invalid') {
                    stats.invalidClaimsCount++;
                    stats.invalidClaimsTotal += (order.total || 0);
                } else if (claimsStatus === 'not for claims') {
                    stats.notForClaimsCount++;
                    stats.notForClaimsTotal += (order.total || 0);
                }
            };

            if (platformStats[platform]) {
                updateStats(platformStats[platform], o);
            }
            updateStats(platformStats['All'], o);
        });

        // --- Update DOM for each platform ---
        for (const platform in platformStats) {
            const stats = platformStats[platform];
            const p = platform.toLowerCase(); // for ID construction

            // WINS
            document.getElementById(`dash-${p}-wins-success`).innerText = stats.successCount;
            document.getElementById(`dash-${p}-wins-success-total`).innerText = '‚Ç±' + stats.successTotal.toFixed(2);
            document.getElementById(`dash-${p}-wins-failed`).innerText = stats.failedCount;
            document.getElementById(`dash-${p}-wins-failed-total`).innerText = '‚Ç±' + stats.failedTotal.toFixed(2);
            document.getElementById(`dash-${p}-wins-intransit`).innerText = stats.intransitCount;
            document.getElementById(`dash-${p}-wins-intransit-total`).innerText = '‚Ç±' + stats.intransitTotal.toFixed(2);

            // Claims
            document.getElementById(`dash-${p}-claims-pending-count`).innerText = stats.pendingClaimsCount;
            document.getElementById(`dash-${p}-claims-pending-total`).innerText = '‚Ç±' + stats.pendingClaimsTotal.toFixed(2);
            document.getElementById(`dash-${p}-claims-approved-count`).innerText = stats.approvedClaimsCount;
            document.getElementById(`dash-${p}-claims-approved-total`).innerText = '‚Ç±' + stats.approvedClaimsTotal.toFixed(2);
            document.getElementById(`dash-${p}-claims-invalid-count`).innerText = stats.invalidClaimsCount;
            document.getElementById(`dash-${p}-claims-invalid-total`).innerText = '‚Ç±' + stats.invalidClaimsTotal.toFixed(2);
            document.getElementById(`dash-${p}-claims-notforclaims-count`).innerText = stats.notForClaimsCount;
            document.getElementById(`dash-${p}-claims-notforclaims-total`).innerText = '‚Ç±' + stats.notForClaimsTotal.toFixed(2);
        }

        // Render Overview Chart
        renderOverviewChart(platformStats);
    }

    function renderOverviewChart(stats) {
        const ctx = document.getElementById('overviewChart').getContext('2d');
        const platforms = ['Tiktok', 'Shopee', 'Lazada', 'Watsons'];
        
        const dataIntransit = platforms.map(p => stats[p].intransitCount);
        const dataSuccess = platforms.map(p => stats[p].successCount);
        const dataFailed = platforms.map(p => stats[p].failedCount);

        if (overviewChartInstance) overviewChartInstance.destroy();

        overviewChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: platforms,
                datasets: [
                    {
                        label: 'Intransit',
                        data: dataIntransit,
                        backgroundColor: '#3498db'
                    },
                    {
                        label: 'Success',
                        data: dataSuccess,
                        backgroundColor: '#2ecc71'
                    },
                    {
                        label: 'Failed',
                        data: dataFailed,
                        backgroundColor: '#e74c3c'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                },
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    function openDashTab(platformName) {
        // Hide all contents
        const contents = document.getElementsByClassName("dash-tab-content");
        for (let i = 0; i < contents.length; i++) {
            contents[i].classList.remove("active");
        }
        
        // Update tabs styling
        const tabs = document.querySelectorAll(".dashboard-tabs .dash-tab");
        tabs.forEach(tab => tab.classList.remove("active"));
        
        // Show specific content and activate tab
        document.getElementById("dash-tab-" + platformName).classList.add("active");
        const activeBtn = document.querySelector(`.dashboard-tabs .dash-tab[onclick*="${platformName}"]`);
        if(activeBtn) activeBtn.classList.add("active");
    }

    // --- Platform Logic ---
    let currentPlatform = 'Tiktok';

    function switchPlatform(platform) {
        currentPlatform = platform;
        
        // Update UI Tabs
        document.querySelectorAll('.platform-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.platform === platform) {
                tab.classList.add('active');
            }
        });

        // Update Header Text
        const header = document.getElementById('platformIdHeader');
        if(header) header.innerText = platform === 'All' ? 'Platform Order ID' : `${platform} Order ID`;

        // Reset and Render
        currentPage = 1;
        renderOrderList();
    }

    // --- List Logic ---
    function renderOrderList() {
        const tbody = document.querySelector('#ordersTable tbody');
        tbody.innerHTML = '';
        
        // Reset select all checkbox
        if(document.getElementById('selectAllOrders')) document.getElementById('selectAllOrders').checked = false;

        // Filters
        const fId = document.getElementById('filterId') ? document.getElementById('filterId').value.toLowerCase() : '';
        const fStatus = document.getElementById('filterStatus') ? document.getElementById('filterStatus').value : '';
        const fStart = document.getElementById('filterStartDate') ? document.getElementById('filterStartDate').value : '';
        const fEnd = document.getElementById('filterEndDate') ? document.getElementById('filterEndDate').value : '';

        let allOrders = Object.values(orders);

        // Filter
        let filteredOrders = allOrders.filter(order => {
            // Platform Filter
            const p = order.platform || 'Tiktok';
            if (currentPlatform !== 'All' && p !== currentPlatform) return false;

            const matchesId = order.id.toLowerCase().includes(fId);
            const matchesStatus = fStatus === '' || String(order.status).toLowerCase().includes(fStatus.toLowerCase());
            let matchesDate = true;
            if (fStart) matchesDate = matchesDate && (order.date >= fStart);
            if (fEnd) matchesDate = matchesDate && (order.date <= fEnd);
            return matchesId && matchesStatus && matchesDate;
        });
        
        // Sort
        if (currentSort.column !== null) {
            filteredOrders.sort((a, b) => {
                const valA = getValueForColumn(a, currentSort.column);
                const valB = getValueForColumn(b, currentSort.column);
                
                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Paginate
        const totalPages = Math.ceil(filteredOrders.length / itemsPerPage) || 1;
        
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const paginatedOrders = filteredOrders.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

        paginatedOrders.forEach(order => {
            const dateObj = new Date(order.date);
            const month = dateObj.toLocaleString('default', { month: 'short' });
            const today = new Date();
            const ageing = Math.floor((today - dateObj) / (1000 * 60 * 60 * 24));

            const tr = document.createElement('tr');
            tr.ondblclick = () => enableEditRow(tr, order.id);
            tr.innerHTML = `
                <td><input type="checkbox" class="order-checkbox" value="${order.id}"></td>
                <td>${month}</td>
                <td>${order.date}</td>
                <td>${order.shipDateTime || '-'}</td>
                <td>${order.deliveryDate || '-'}</td>
                <td>${ageing}</td>
                <td>${order.id}</td>
                <td>${order.tiktokId || '-'}</td>
                <td>${order.items}</td>
                <td>${order.mop || 'COD'}</td>
                <td>${order.status}</td>
                <td>${order.scSubStatus || '-'}</td>
                <td>${order.ommStatus || '-'}</td>
                <td>${order.ommConsignment || '-'}</td>
                <td>${order.winsStatus || '-'}</td>
                <td>${order.salesTlog || '-'}</td>
                <td>${order.rtsPoNo || '-'}</td>
                <td>${order.rtsPoStatus || '-'}</td>
                <td>${order.returnStatus || '-'}</td>
                <td>${order.returnReason || '-'}</td>
                <td>${order.cancelReason || '-'}</td>
                <td>${order.physicalStocks || '-'}</td>
                <td>${order.rtvDate || '-'}</td>
                <td>${order.ticketNumber || '-'}</td>
                <td>${order.dateFiled || '-'}</td>
                <td>${order.feedbackDate || '-'}</td>
                <td>${order.dfClaimsStatus || '-'}</td>
                <td>${order.delFailedReason || '-'}</td>
                <td>${order.returnRefund || '-'}</td>
                <td>${order.rrClaimsStatus || '-'}</td>
                <td>${order.claimsReason || '-'}</td>
                <td>${order.trackingNo || '-'}</td>
                <td>${order.logisticsDel || '-'}</td>
                <td>${order.region || '-'}</td>
                <td>${order.province || '-'}</td>
                <td>${order.remarks || '-'}</td>
                <td>‚Ç±${(order.cost !== undefined ? parseFloat(order.cost) : (order.total * 0.7)).toFixed(2)}</td>
                <td>‚Ç±${order.total.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });

        // Update Pagination Controls
        document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    function enableEditRow(tr, id) {
        if (tr.classList.contains('editing')) return;
        tr.classList.add('editing');
        
        // Change Month cell (index 1) to save button
        tr.cells[1].innerHTML = `<button onclick="saveEditRow(this, '${id}')" style="padding: 4px 8px; font-size: 12px; background-color: #2ecc71; border: none; border-radius: 3px; color: white; cursor: pointer;">üíæ</button>`;

        // Loop through cells
        for (let i = 2; i < tr.cells.length; i++) {
            const key = columnKeys[i-1];
            if (!key) continue; // Skip derived columns like Ageing
            if (key === 'id') continue; // Skip ID (keep read-only)

            const cell = tr.cells[i];
            // Get raw value from object to avoid parsing formatted HTML
            const currentVal = orders[id][key] !== undefined ? orders[id][key] : '';
            
            let type = 'text';
            if (key.includes('date') || key.includes('Date')) type = 'date';
            if (key === 'items' || key === 'total' || key === 'cost') type = 'number';
            
            // Handle cost calculation default if editing for first time
            let val = currentVal;
            if (key === 'cost' && val === '') val = (orders[id].total * 0.7).toFixed(2);

            cell.innerHTML = `<input type="${type}" class="edit-input" value="${String(val).replace(/"/g, '&quot;')}">`;
        }
    }

    function saveEditRow(btn, id) {
        const tr = btn.closest('tr');
        const order = orders[id];
        
        for (let i = 2; i < tr.cells.length; i++) {
            const key = columnKeys[i-1];
            if (!key || key === 'id') continue;
            
            const input = tr.cells[i].querySelector('input, select');
            if (input) {
                let val = input.value;
                if (input.type === 'number') val = parseFloat(val) || 0;
                order[key] = val;
            }
        }
        
        renderOrderList();
        updateDashboard();
        saveOrdersToStorage();
        showNotification('Order updated successfully!');
    }

    function toggleAllCheckboxes(source) {
        const checkboxes = document.querySelectorAll('#ordersTable .order-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = source.checked;
        });
    }

    function deleteSelectedOrders() {
        const checkedBoxes = document.querySelectorAll('#ordersTable .order-checkbox:checked');
        if (checkedBoxes.length === 0) {
            showNotification("Please select orders to delete.", "error");
            return;
        }

        if (confirm(`Are you sure you want to delete ${checkedBoxes.length} selected order(s)?`)) {
            let deletedCount = 0;
            checkedBoxes.forEach(checkbox => {
                if (orders[checkbox.value]) {
                    delete orders[checkbox.value];
                    deletedCount++;
                }
            });
            
            if (deletedCount > 0) {
                saveOrdersToStorage();
                renderOrderList();
                updateDashboard();
                showNotification(`${deletedCount} order(s) deleted successfully.`, 'success');
            }
        }
    }

    function getValueForColumn(order, index) {
        switch(index) {
            case 0: return new Date(order.date); // Month
            case 1: return new Date(order.date); // Order Date
            case 4: return new Date().getTime() - new Date(order.date).getTime(); // Ageing
            case 5: return order.id;
            case 7: return order.items;
            case 9: return order.status;
            case 35: return order.total * 0.7;
            case 36: return order.total;
            default: return '';
        }
    }

    function setupTableSorting() {
        const headers = document.querySelectorAll('#ordersTable thead th');
        headers.forEach((th, index) => {
            th.onclick = () => {
                const direction = (currentSort.column === index && currentSort.direction === 'asc') ? 'desc' : 'asc';
                currentSort = { column: index, direction };
                renderOrderList();
                updateSortIcons(index, direction);
            };
        });
    }

    function updateSortIcons(activeIdx, direction) {
        const headers = document.querySelectorAll('#ordersTable thead th');
        headers.forEach((th, idx) => {
            th.innerText = th.innerText.replace(/ [‚ñ≤‚ñº]/, '');
            if (idx === activeIdx) th.innerText += direction === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        });
    }

    function changePage(direction) {
        currentPage += direction;
        renderOrderList();
    }

    function changeItemsPerPage() {
        itemsPerPage = parseInt(document.getElementById('rowsPerPage').value);
        currentPage = 1;
        renderOrderList();
    }

    function resetFilters() {
        if(document.getElementById('filterId')) document.getElementById('filterId').value = '';
        if(document.getElementById('filterStatus')) document.getElementById('filterStatus').value = '';
        if(document.getElementById('filterStartDate')) document.getElementById('filterStartDate').value = '';
        if(document.getElementById('filterEndDate')) document.getElementById('filterEndDate').value = '';
        filterOrders();
    }

    function toggleTableView() {
        document.body.classList.toggle('table-only-mode');
    }

    function toggleDarkMode() {
        if (document.body.classList.contains('theme-black') || document.body.classList.contains('theme-navy')) {
            applyTheme('light');
        } else {
            applyTheme('black');
        }
    }

    // --- Report Logic ---
    function generateReport() {
        const orderList = Object.values(orders);
        const counts = {};
        orderList.forEach(o => {
            const s = o.status || 'Unknown';
            counts[s] = (counts[s] || 0) + 1;
        });

        let html = Object.entries(counts).map(([k, v]) => `<p><strong>${k}:</strong> ${v}</p>`).join('');
        html += `<hr><p><strong>Total Orders:</strong> ${orderList.length}</p>`;
        document.getElementById('report-content').innerHTML = html;
    }

    // --- Manual Chart Logic ---
    let customChartInstance = null;
    let manualChartState = {
        headers: ['Value 1', 'Value 2'],
        rows: []
    };

    function loadManualData() {
        const saved = localStorage.getItem('manualChartDataV2');
        if (saved) {
            manualChartState = JSON.parse(saved);
        } else {
            // Migration from V1
            const v1Data = JSON.parse(localStorage.getItem('manualChartData'));
            if (v1Data && v1Data.length) {
                manualChartState.rows = v1Data.map(r => ({
                    label: r.label,
                    values: [r.val1, r.val2]
                }));
            } else {
                // Default init
                if (manualChartState.rows.length === 0) {
                    manualChartState.rows.push({ label: '', values: ['', ''] });
                }
            }
        }
        
        const savedType = localStorage.getItem('manualChartType');
        if (savedType) document.getElementById('chartTypeSelector').value = savedType;

        const savedSecondary = localStorage.getItem('manualChartSecondary') === 'true';
        if (document.getElementById('useSecondaryAxis')) document.getElementById('useSecondaryAxis').checked = savedSecondary;

        renderManualTable();
    }

    function renderManualTable() {
        // 1. Headers
        const headerRow = document.getElementById('manualHeaderRow');
        // Remove existing dynamic headers (keep first and last)
        while (headerRow.children.length > 2) {
            headerRow.removeChild(headerRow.children[1]);
        }
        
        const actionTh = headerRow.lastElementChild;
        manualChartState.headers.forEach((h, i) => {
            const th = document.createElement('th');
            // Drag attributes
            th.draggable = true;
            th.classList.add('draggable');
            th.ondragstart = (e) => handleDragStart(e, 'col', i);
            th.ondragover = handleDragOver;
            th.ondragenter = handleDragEnter;
            th.ondragleave = handleDragLeave;
            th.ondrop = (e) => handleDrop(e, 'col', i);
            th.ondragend = handleDragEnd;

            th.innerHTML = `
                <span contenteditable="true" onblur="updateHeaderName(${i}, this.innerText)">${h}</span>
                <span onclick="deleteColumn(${i})" style="cursor:pointer; color:#e74c3c; margin-left:5px; font-size:14px; font-weight:bold;">&times;</span>
            `;
            headerRow.insertBefore(th, actionTh);
        });

        // 2. Body
        const tbody = document.getElementById('manualReportBody');
        tbody.innerHTML = '';
        
        manualChartState.rows.forEach((row, rIndex) => {
            const tr = document.createElement('tr');
            // Drag attributes
            tr.draggable = true;
            tr.classList.add('draggable');
            tr.ondragstart = (e) => handleDragStart(e, 'row', rIndex);
            tr.ondragover = handleDragOver;
            tr.ondragenter = handleDragEnter;
            tr.ondragleave = handleDragLeave;
            tr.ondrop = (e) => handleDrop(e, 'row', rIndex);
            tr.ondragend = handleDragEnd;

            let html = `<td contenteditable="true" class="chart-label" data-placeholder="Item Name" oninput="updateRowLabel(${rIndex}, this.innerText)" onpaste="handleManualPaste(event, ${rIndex}, -1)">${row.label}</td>`;
            
            // Sync values length
            while(row.values.length < manualChartState.headers.length) row.values.push('');
            
            row.values.forEach((val, cIndex) => {
                html += `<td contenteditable="true" class="chart-value" data-placeholder="0" oninput="updateRowValue(${rIndex}, ${cIndex}, this.innerText)" onpaste="handleManualPaste(event, ${rIndex}, ${cIndex})">${val}</td>`;
            });
            
            html += `<td><button onclick="removeManualRow(${rIndex})" style="background-color: #e74c3c; padding: 8px;">X</button></td>`;
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        calculateManualTotal();
    }

    function addColumn() {
        manualChartState.headers.push(`Value ${manualChartState.headers.length + 1}`);
        manualChartState.rows.forEach(r => r.values.push(''));
        saveAndRender();
    }

    function deleteColumn(index) {
        if (manualChartState.headers.length <= 1) {
            alert("Cannot delete the last value column.");
            return;
        }
        if (confirm("Delete this column?")) {
            manualChartState.headers.splice(index, 1);
            manualChartState.rows.forEach(r => r.values.splice(index, 1));
            saveAndRender();
        }
    }

    function transposeTable() {
        if (manualChartState.rows.length === 0 && manualChartState.headers.length === 0) {
            alert("Cannot transpose an empty table.");
            return;
        }

        // New headers are the old row labels. Provide a default if a label is empty.
        const newHeaders = manualChartState.rows.map((r, i) => r.label || `Item ${i + 1}`);

        // New rows are created from old headers.
        const newRows = manualChartState.headers.map((oldHeader, colIndex) => {
            return {
                label: oldHeader,
                // The values for this new row are all the values from the old column `colIndex`.
                values: manualChartState.rows.map(oldRow => oldRow.values[colIndex] || '')
            };
        });

        manualChartState.headers = newHeaders;
        manualChartState.rows = newRows;

        saveAndRender();
    }

    // --- Drag & Drop Logic ---
    let dragSrcIndex = null;
    let dragType = null;

    function handleDragStart(e, type, index) {
        dragSrcIndex = index;
        dragType = type;
        e.target.style.opacity = '0.4';
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        const target = e.target.closest(dragType === 'row' ? 'tr' : 'th');
        if(target) target.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        const target = e.target.closest(dragType === 'row' ? 'tr' : 'th');
        if(target) target.classList.remove('drag-over');
    }

    function handleDragEnd(e) {
        e.target.style.opacity = '1';
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }

    function handleDrop(e, type, targetIndex) {
        if (e.stopPropagation) e.stopPropagation();
        
        if (dragType !== type || dragSrcIndex === targetIndex) return false;

        if (type === 'row') {
            const movedRow = manualChartState.rows.splice(dragSrcIndex, 1)[0];
            manualChartState.rows.splice(targetIndex, 0, movedRow);
        } else if (type === 'col') {
            const movedHeader = manualChartState.headers.splice(dragSrcIndex, 1)[0];
            manualChartState.headers.splice(targetIndex, 0, movedHeader);
            
            manualChartState.rows.forEach(row => {
                const movedVal = row.values.splice(dragSrcIndex, 1)[0];
                row.values.splice(targetIndex, 0, movedVal);
            });
        }

        saveAndRender();
        return false;
    }

    function addManualRow() {
        const emptyVals = new Array(manualChartState.headers.length).fill('');
        manualChartState.rows.push({ label: '', values: emptyVals });
        saveAndRender();
    }

    function removeManualRow(index) {
        manualChartState.rows.splice(index, 1);
        saveAndRender();
    }

    function updateHeaderName(index, name) {
        manualChartState.headers[index] = name;
        saveManualData();
    }

    function updateRowLabel(index, val) {
        manualChartState.rows[index].label = val;
        saveManualData();
    }

    function updateRowValue(rIndex, cIndex, val) {
        manualChartState.rows[rIndex].values[cIndex] = val;
        calculateManualTotal();
        saveManualData();
    }

    function handleManualPaste(e, startRow, startCol) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        if (!text) return;

        const rows = text.split(/\r\n|\n|\r/).filter(r => r.trim());
        
        rows.forEach((rowStr, i) => {
            const currentRowIdx = startRow + i;
            // Detect delimiter (Tab for Excel, Comma for CSV)
            let cols = rowStr.split('\t');
            if (cols.length === 1 && rowStr.includes(',')) {
                cols = rowStr.split(',');
            }
            
            // Add new row if needed
            if (!manualChartState.rows[currentRowIdx]) {
                const emptyVals = new Array(manualChartState.headers.length).fill('');
                manualChartState.rows.push({ label: '', values: emptyVals });
            }

            cols.forEach((val, j) => {
                const currentColIdx = startCol + j;
                
                if (currentColIdx === -1) {
                    manualChartState.rows[currentRowIdx].label = val.trim();
                } else if (currentColIdx >= 0 && currentColIdx < manualChartState.headers.length) {
                    manualChartState.rows[currentRowIdx].values[currentColIdx] = val.trim();
                }
            });
        });
        saveAndRender();
    }

    function saveAndRender() {
        saveManualData();
        renderManualTable();
    }

    function saveManualData() {
        localStorage.setItem('manualChartDataV2', JSON.stringify(manualChartState));
        localStorage.setItem('manualChartType', document.getElementById('chartTypeSelector').value);
        if (document.getElementById('useSecondaryAxis')) localStorage.setItem('manualChartSecondary', document.getElementById('useSecondaryAxis').checked);
    }

    function calculateManualTotal() {
        const container = document.getElementById('manualTotalsContainer');
        const totals = manualChartState.headers.map(() => 0);
        
        manualChartState.rows.forEach(row => {
            row.values.forEach((val, i) => {
                totals[i] += parseFloat(val) || 0;
            });
        });

        container.innerHTML = totals.map((t, i) => {
            const color = `hsl(${i * 137.5 % 360}, 70%, 40%)`;
            return `<span style="color:${color}; font-weight:bold;">${manualChartState.headers[i]}: ${t.toFixed(2)}</span>`;
        }).join(' | ');
    }

    function renderManualChart() {
        const ctx = document.getElementById('customChartCanvas').getContext('2d');
        const type = document.getElementById('chartTypeSelector').value;
        const useSecondary = document.getElementById('useSecondaryAxis') ? document.getElementById('useSecondaryAxis').checked : false;
        
        const labels = manualChartState.rows.map(r => r.label).filter(l => l);
        const validRows = manualChartState.rows.filter(r => r.label);
        
        const datasets = manualChartState.headers.map((header, i) => {
            const data = validRows.map(r => parseFloat(r.values[i]) || 0);
            const baseColor = i * 137.5 % 360;
            
            // Check if this is the secondary dataset (last column, if enabled)
            const isSecondary = useSecondary && i === manualChartState.headers.length - 1 && manualChartState.headers.length > 1;
            // Check if label explicitly requests line (e.g. "Target (Line)")
            const isExplicitLine = header.toLowerCase().includes('(line)');

            const color = `hsl(${baseColor}, 70%, 60%)`;
            const bgColors = type === 'pie' || type === 'doughnut' 
                ? validRows.map((_, ri) => `hsl(${baseColor + (ri * 30)}, 70%, 60%)`) 
                : (type === 'line' ? `hsla(${baseColor}, 70%, 60%, 0.2)` : color);
            
            const dataset = {
                label: header,
                data: data,
                backgroundColor: bgColors,
                borderColor: `hsl(${baseColor}, 70%, 50%)`,
                borderWidth: 1,
                fill: type === 'line'
            };

            if ((isSecondary || isExplicitLine) && type !== 'pie' && type !== 'doughnut') {
                dataset.type = 'line';
                dataset.yAxisID = isSecondary ? 'y1' : 'y';
                if (isSecondary) dataset.borderColor = '#e74c3c'; // Distinct color for secondary axis
                dataset.backgroundColor = 'transparent';
                dataset.borderWidth = 2;
            } else {
                dataset.yAxisID = 'y';
            }

            return dataset;
        });

        if (customChartInstance) customChartInstance.destroy();

        const options = {
            responsive: true,
            scales: {
                y: { beginAtZero: true, display: type !== 'pie' && type !== 'doughnut' }
            }
        };

        if (useSecondary && manualChartState.headers.length > 1 && type !== 'pie' && type !== 'doughnut') {
            options.scales.y1 = {
                type: 'linear',
                display: true,
                position: 'right',
                grid: {
                    drawOnChartArea: false
                }
            };
        }

        customChartInstance = new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: datasets
            },
            options: options
        });
    }

    // --- Theme Logic ---
    function applyTheme(themeName) {
        // Remove all theme classes
        document.body.classList.remove('theme-black', 'theme-navy', 'theme-cream', 'theme-pastel');
        
        if (themeName !== 'light') {
            document.body.classList.add('theme-' + themeName);
        }
        // Save
        localStorage.setItem('appTheme', themeName);
    }

    // --- Settings Logic ---
    function setFontSize(size) {
        let px = '16px';
        if(size === 'small') px = '14px';
        if(size === 'large') px = '18px';
        document.documentElement.style.setProperty('--app-font-size', px);
        localStorage.setItem('fontSize', size);
    }

    function setDensity(density) {
        if(density === 'compact') document.body.classList.add('view-compact');
        else document.body.classList.remove('view-compact');
        localStorage.setItem('viewDensity', density);
    }

    function clearAllData() {
        if (confirm("Are you sure you want to delete ALL order data? This action cannot be undone.")) {
            orders = {};
            localStorage.removeItem('ordersData');
            
            // Update dashboard stats immediately
            updateDashboard();
            showNotification("All order data has been cleared.");
        }
    }

    // Initialize Settings
    (function() {
        const savedFontSize = localStorage.getItem('fontSize') || 'medium';
        const savedDensity = localStorage.getItem('viewDensity') || 'comfortable';
        setFontSize(savedFontSize);
        setDensity(savedDensity);
    })();

    // Initialize Theme from LocalStorage
    (function() {
        const savedTheme = localStorage.getItem('appTheme') || 'light';
        applyTheme(savedTheme);
    })();

    // Initialize Session (Persist Page)
    (function() {
        const loggedIn = localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true';
        if (loggedIn) {
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('mainContent').style.marginLeft = '250px';
            document.getElementById('topHeader').style.display = 'flex';
            updateHeaderProfile();
            
            const savedView = localStorage.getItem('currentView') || 'dashboard';
            showView(savedView);
        }
    })();

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        sidebar.classList.toggle('collapsed');
        
        // Adjust margin based on state
        const isCollapsed = sidebar.classList.contains('collapsed');
        mainContent.style.marginLeft = isCollapsed ? '70px' : '250px';
    }

    function toggleProfileMenu(e) {
        if(e) e.stopPropagation();
        document.getElementById('profileMenu').classList.toggle('show');
    }

    // Close dropdown when clicking outside
    window.onclick = function(event) {
        if (!event.target.closest('.profile-trigger')) {
            const dropdowns = document.getElementsByClassName("dropdown-menu");
            for (let i = 0; i < dropdowns.length; i++) {
                dropdowns[i].classList.remove('show');
            }
        }
    }

    function filterOrders() {
        currentPage = 1;
        renderOrderList();
    }

    function exportToCSV() {
        const orderList = Object.values(orders);
        if (orderList.length === 0) {
            alert("No orders to export.");
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        // The header is static and matches the import format
        csvContent += "Platform,Month,Order Date,Ship Date Time,Delivery Date,Ageing Days,Order Number,Tiktok Order ID,Units Shipped,MOP,SC Order Status,SC Order Sub Status,OMM Customer Order Status,OMM Consignment Status,WINS Status,Sales/TLOG,RTS PO NO,RTS PO Status,Return Status,Return Reason,Cancel Reason,Physical Stocks,RTV Date Endorse to IC,Ticket Number,Date Filed,Feedback Date,DF Claims Status,Del-Failed Reason,Return/Refund,RR Claims Status,Claims Reason,Tracking No.,Logistics Del,Region,Province,Order Status Final Remarks,Total Cost,Total Retail\n";

        // Helper to safely get value and handle commas for CSV
        const sanitize = (val) => {
            if (val === undefined || val === null) return '';
            const str = String(val);
            // If the string contains a comma, wrap it in double quotes
            if (str.includes(',')) return `"${str.replace(/"/g, '""')}"`;
            return str;
        };

        orderList.forEach(order => {
            const dateObj = new Date(order.date);
            const month = dateObj.toLocaleString('default', { month: 'short' });
            const today = new Date();
            const ageing = Math.floor((today - dateObj) / (1000 * 60 * 60 * 24));

            const rowData = [
                order.platform,
                month,
                order.date,
                order.shipDateTime,
                order.deliveryDate,
                ageing,
                order.id,
                order.tiktokId,
                order.items,
                order.mop,
                order.status,
                order.scSubStatus,
                order.ommStatus,
                order.ommConsignment,
                order.winsStatus,
                order.salesTlog,
                order.rtsPoNo,
                order.rtsPoStatus,
                order.returnStatus,
                order.returnReason,
                order.cancelReason,
                order.physicalStocks,
                order.rtvDate,
                order.ticketNumber,
                order.dateFiled,
                order.feedbackDate,
                order.dfClaimsStatus,
                order.delFailedReason,
                order.returnRefund,
                order.rrClaimsStatus,
                order.claimsReason,
                order.trackingNo,
                order.logisticsDel,
                order.region,
                order.province,
                order.remarks,
                (order.cost !== undefined ? parseFloat(order.cost) : (order.total * 0.7)).toFixed(2),
                order.total.toFixed(2)
            ].map(val => sanitize(val)).join(",");
            
            csvContent += rowData + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "orders_export.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- Data Import/Export ---
    function downloadSampleCSV() {
        const headers = "Platform,Month,Order Date,Ship Date Time,Delivery Date,Ageing Days,Order Number,Tiktok Order ID,Units Shipped,MOP,SC Order Status,SC Order Sub Status,OMM Customer Order Status,OMM Consignment Status,WINS Status,Sales/TLOG,RTS PO NO,RTS PO Status,Return Status,Return Reason,Cancel Reason,Physical Stocks,RTV Date Endorse to IC,Ticket Number,Date Filed,Feedback Date,DF Claims Status,Del-Failed Reason,Return/Refund,RR Claims Status,Claims Reason,Tracking No.,Logistics Del,Region,Province,Order Status Final Remarks,Total Cost,Total Retail";
        
        const rows = [
            "Tiktok,Oct,2023-10-01,,,25,ORD-001,,2,COD,Delivered,,,,,,,,,,,,,,,,,,,,,,,,,,1050.00,1500.00",
            "Shopee,Oct,2023-10-05,,,20,ORD-002,,1,COD,Shipped,,,,,,,,,,,,,,,,,,,,,,,,,,595.35,850.50",
            "Lazada,Oct,2023-10-12,,,15,ORD-003,,4,COD,Processing,,,,,,,,,,,,,,,,,,,,,,,,,,2240.00,3200.00"
        ];

        const csvContent = "data:text/csv;charset=utf-8," + headers + "\n" + rows.join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "sample_orders.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            processCSVData(e.target.result);
            input.value = ''; 
        };
        reader.readAsText(file);
    }

    function processCSVData(text) {
        // Show loading overlay
        const loader = document.getElementById('loading-overlay');
        loader.classList.add('active');

        // Use setTimeout to allow the UI to render the loader before processing
        setTimeout(() => {
            try {
                const rows = text.split(/\r\n|\n|\r/).map(r => r.trim()).filter(r => r);
                
                if (rows.length < 2) {
                    throw new Error('CSV data is empty or invalid.');
                }

                // Detect Platform Column (Check first header)
                const headerRow = rows[0].split(/,|\t/).map(h => h.trim().toLowerCase().replace(/"/g, ''));
                const hasPlatformCol = headerRow[0] === 'platform';
                const offset = hasPlatformCol ? 1 : 0;

                let importedCount = 0;
                // Start from index 1 to skip header
                for (let i = 1; i < rows.length; i++) {
                    // Support Tab (Excel) or Comma (CSV)
                    let cols = rows[i].split('\t');
                    if (cols.length === 1) cols = rows[i].split(',');

                    // Need at least enough columns to reach ID (index 5 + offset)
                    if (cols.length <= (5 + offset)) continue;

                    // Mapping based on the 37-column structure
                    const idIdx = 5 + offset;
                    const id = cols[idIdx] ? cols[idIdx].trim() : `IMP-${Date.now()}-${i}`;
                    
                    // Determine Platform
                    let platform = currentPlatform;
                    if (hasPlatformCol && cols[0]) {
                        const pVal = cols[0].trim().toLowerCase();
                        if (pVal.includes('tiktok')) platform = 'Tiktok';
                        else if (pVal.includes('shopee')) platform = 'Shopee';
                        else if (pVal.includes('lazada')) platform = 'Lazada';
                        else if (pVal.includes('watson')) platform = 'Watsons';
                    }
                    
                    const newOrder = { id: id, platform: platform, customer: 'Imported' };

                    columnKeys.forEach((key, index) => {
                        const colIndex = index + offset;
                        if (key && colIndex < cols.length) {
                            let val = cols[colIndex] ? cols[colIndex].trim() : '';
                            if (val === '-') val = ''; // Treat placeholder '-' as an empty field
                            
                            if (key === 'items') val = parseInt(val) || 0;
                            if (key === 'total' || key === 'cost') val = parseFloat(val) || 0;
                            if (key === 'date' && !val) val = new Date().toISOString().split('T')[0];
                            newOrder[key] = val;
                        }
                    });

                    orders[id] = newOrder;
                    importedCount++;
                }

                saveOrdersToStorage();
                renderOrderList();
                updateDashboard();
                showNotification(`Successfully imported ${importedCount} orders.`, 'success');
            } catch (error) {
                console.error(error);
                showNotification(error.message || 'Failed to process CSV data.', 'error');
            } finally {
                // Hide loading overlay
                loader.classList.remove('active');
            }
        }, 800); // Artificial delay (800ms) so user sees the animation
    }

    function showNotification(message, type = 'success') {
        const existing = document.getElementById('notification-toast');
        if (existing) document.body.removeChild(existing);

        const div = document.createElement('div');
        div.id = 'notification-toast';
        
        // Determine color based on type
        const bgColor = type === 'error' ? '#e74c3c' : '#2ecc71';
        
        div.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: ${bgColor};
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: toast-in 0.3s ease;
        `;
        div.innerText = message;
        document.body.appendChild(div);
        
        // Fade out and remove
        setTimeout(() => { 
            if(document.body.contains(div)) {
                div.style.opacity = '0';
                div.style.transition = 'opacity 0.5s';
                setTimeout(() => { if(document.body.contains(div)) document.body.removeChild(div); }, 500);
            } 
        }, 3000);
    }

    // Initialize Sorting
    setupTableSorting();
</script>

</body>
</html>

 
